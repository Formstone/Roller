/*
 * Roller Plugin [Formtone Library]
 * @author Ben Plum
 * @version 0.0.2
 *
 * Copyright Â© 2013 Ben Plum <mr@benplum.com>
 * Released under the MIT License <http://www.opensource.org/licenses/mit-license.php>
 */

if(jQuery)(function(d){function q(a){a=d.extend({},m,a);for(var b=d(this),c=0,e=b.length;c<e;c++)r(b.eq(c),a);return b}function r(a,b){if(!a.data("roller")){var c=d.extend({},{$roller:a,$viewport:a.find(".roller-viewport"),$canister:a.find(".roller-canister"),$items:a.find(".roller-item"),$captions:a.find(".roller-captions"),$captionItems:a.find(".roller-caption"),$controls:a.find(".roller-controls"),$controlItems:a.find(".roller-control"),$pagination:a.find(".roller-pagination"),$paginationItems:a.find(".roller-page"), $images:a.find("img"),isAnimating:!1,index:-1,delta:0,leftPosition:0,xStart:0,guid:s++,breakWidth:parseInt(a.data("max-width"))||Infinity,enabled:!1},b);c.totalImages=c.$images.length;g.enable(c);c.auto&&k(c.autoTimer,c.autoTime,function(){var a=c.index+1;a>c.pageCount&&(a=0);h(c,a,!0);f(c.autoTimer)});if(0<c.totalImages)for(var e=c.loadedImages=0;e<c.totalImages;e++){var l=c.$images.eq(e);l.one("load",c,t);(l[0].complete||l[0].height)&&l.trigger("load")}}}function t(a){a=a.data;a.loadedImages++; a.loadedImages==a.totalImages&&a.$roller.trigger("resize.roller");a.$roller.data("roller",a)}function u(a){a.preventDefault();a.stopPropagation();var b=a.data;f(b.autoTimer);f(b.touchTimer);if(!b.isAnimating){var c="undefined"!==typeof a.originalEvent.targetTouches?a.originalEvent.targetTouches[0]:null;b.xStart=c?c.pageX:a.clientX;Site.$window.on("touchmove",b,p).one("touchend",b,n)}}function p(a){var b=a.data,c="undefined"!==typeof a.originalEvent.targetTouches?a.originalEvent.targetTouches[0]:null; b.delta=b.xStart-(c?c.pageX:a.clientX);20<b.delta&&(a.preventDefault(),a.stopPropagation());c=b.leftPosition-b.delta;0<c&&(c=0);c<b.maxMove&&(c=b.maxMove);b.useMargin?b.$canister.css({marginLeft:c}):b.$canister.css({transform:"translate3D("+c+"px,0,0)"});k(b.touchTimer,300,function(){n(a)})}function n(a){a.preventDefault();a.stopPropagation();a=a.data;var b=0.25*a.pageWidth,c=a.index;f(a.touchTimer);Site.$window.off("touchmove",p).off("touchend",n);if(a.delta){if(a.delta>b||a.delta<-b)c=a.index+(a.leftPosition- a.delta<=a.leftPosition?1:-1);h(a,c,!0);a.delta=null}}function v(a){a.preventDefault();a.stopPropagation();var b=d(a.delegateTarget).data("roller");f(b.autoTimer);b.isAnimating||(a=b.index+(d(a.currentTarget).hasClass("next")?1:-1),h(b,a,!0))}function w(a){a.preventDefault();a.stopPropagation();var b=d(a.delegateTarget).data("roller");a=b.$paginationItems.index(d(a.currentTarget));f(b.autoTimer);h(b,a,!0)}function h(a,b,c){c&&(a.isAnimating=!0,a.$roller.addClass("animated"));f(a.touchTimer);0>b&& (b=0);b>a.pageCount&&(b=a.pageCount);var e=-(b*a.pageMove);e<a.maxMove&&(e=a.maxMove);a.leftPosition=e;a.useMargin?a.$canister.css({marginLeft:a.leftPosition}):a.$canister.css({transform:"translate3D("+a.leftPosition+"px,0,0)"});a.$captionItems.filter(".active").removeClass("active");a.$captionItems.eq(b).addClass("active");a.$paginationItems.filter(".active").removeClass("active");a.$paginationItems.eq(b).addClass("active");a.$items.removeClass("visible");if("Infinity"!=a.perPage)for(var d=0;d<a.perPage;d++)e== a.maxMove?a.$items.eq(a.count-1-d).addClass("visible"):a.$items.eq(a.perPage*b+d).addClass("visible");a.index=b;a.$roller.data("roller",a);x(a);c&&k(a.autoTimer,a.speed,function(){a.isAnimating=!1;a.$roller.removeClass("animated")})}function x(a){0>=a.pageCount?a.$controlItems.addClass("disabled"):(a.$controlItems.removeClass("disabled"),0>=a.index?a.$controlItems.filter(".previous").addClass("disabled"):a.index>=a.pageCount&&a.$controlItems.filter(".next").addClass("disabled"))}function k(a,b,c){f(a); setTimeout(c,b)}function f(a){null!=a&&clearTimeout(a)}var s=0,m={autoTime:8E3,auto:!1,customClass:"",speed:250,useMargin:!1},g={defaults:function(a){m=d.extend(m,a||{});return d(this)},disable:function(a){a.enabled&&(f(a.autoTimer),a.$roller.removeClass("initialized").off("click.roller").off("click.roller").off("resize.roller").off("reset.roller").off("touchstart"),a.$pagination.html(""),a.useMargin?a.$canister.css({marginLeft:"0"}):a.$canister.css({transform:"translate3D(0,0,0)"}),a.index=0);a.enabled= !1},enable:function(a){a.enabled||a.$roller.data("roller",a).on("click.roller",".roller-control",v).on("click.roller",".roller-page",w).on("resize.roller",a,g.resize).on("reset.roller",a,g.reset).on("respond.roller",a,g.respond).on("touchstart",a,u).trigger("resize.roller");a.enabled=!0},jump:function(a,b,c){h(a,b,c||!0)},resize:function(a){var b=d(a.delegateTarget).data("roller");k(b.autoTimer,Site.debounceTime,function(){b.$roller.addClass("initialized");b.count=b.$items.length;b.pageWidth=0<b.$viewport.length? b.$viewport.outerWidth(!0):b.$roller.outerWidth(!0);b.itemWidth=b.$items.eq(0).outerWidth(!0);b.itemMargin=parseInt(b.$items.eq(0).css("margin-right"),10);b.perPage=Math.floor(b.pageWidth/b.itemWidth);b.pageCount=Math.ceil(b.count/b.perPage)-1;b.pageMove=b.itemWidth*b.perPage;b.maxWidth=b.itemWidth*b.count;b.maxMove=-b.maxWidth+b.pageWidth+b.itemMargin;0<b.maxMove&&(b.maxMove=0);if("Infinity"!=b.pageCount){for(var a="",d=0;d<=b.pageCount;d++)a+='<span class="roller-page">'+d+"</span>";b.$pagination.html(a)}1> b.pageCount?(b.$controls.addClass("hidden"),b.$pagination.addClass("hidden")):(b.$controls.removeClass("hidden"),b.$pagination.removeClass("hidden"));b.$paginationItems=b.$roller.find(".roller-page");a=-Math.ceil(b.leftPosition/b.pageWidth);h(b,a,!1)})},reset:function(a){a=d(a.delegateTarget).data("roller");a.$itemsAll=a.$roller.find(".roller_item");a.$items=a.$allItems.filter(":visible");a.$roller.trigger("resize.roller");h(a,a.index,!1)},respond:function(a){a=d(a.delegateTarget).data("roller"); a.breakWidth>=Site.minWidth?g.enable(a):g.disable(a)}};d.fn.roller=function(a){return g[a]?g[a].apply(this,Array.prototype.slice.call(arguments,1)):"object"!==typeof a&&a?this:q.apply(this,arguments)}})(jQuery);