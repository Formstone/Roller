/*
 * Roller Plugin [Formtone Library]
 * @author Ben Plum
 * @version 1.2.4
 *
 * Copyright Â© 2013 Ben Plum <mr@benplum.com>
 * Released under the MIT License <http://www.opensource.org/licenses/mit-license.php>
 */

if(jQuery)(function(d){function s(a){a=d.extend({},l,a);for(var b=d(this),c=0,f=b.length;c<f;c++)t(b.eq(c),a);return b}function t(a,b){if(!a.data("roller")){var c=d.extend({},{$roller:a,$viewport:a.find(".roller-viewport").eq(0),$canister:a.find(".roller-canister").eq(0),$captions:a.find(".roller-captions").eq(0),$controls:a.find(".roller-controls").eq(0),$pagination:a.find(".roller-pagination").eq(0),index:0,deltaX:null,deltaY:null,leftPosition:0,xStart:0,yStart:0,guid:u++,minWidth:parseInt(a.data("roller-min-width"), 10)||b.minWidth,enabled:!1,touchstart:0,touchEnd:0},b);c.$items=c.$canister.children(".roller-item");c.$captionItems=c.$captions.find(".roller-caption");c.$controlItems=c.$controls.find(".roller-control");c.$paginationItems=c.$pagination.find(".roller-page");c.$images=c.$canister.find("img");c.totalImages=c.$images.length;a.data("roller",c).on("respond.roller",c,v);c.initOnload&&k.enable.apply(c.$roller);c.auto&&(c.autoTimer=w(c.autoTimer,c.autoTime,function(){var a=c.index+1;a>c.pageCount&&(a=0); g(c,a)},!0));if(0<c.totalImages)for(var f=c.loadedImages=0;f<c.totalImages;f++){var e=c.$images.eq(f);e.one("load.roller",c,x);(e[0].complete||e[0].height)&&e.trigger("load.roller")}}}function x(a){a=a.data;a.loadedImages++;a.loadedImages==a.totalImages&&a.$roller.trigger("resize.roller")}function y(a){a.stopPropagation();var b=a.data;h(b.autoTimer);b.touchStart=(new Date).getTime();b.$canister.css(p("none"));var c="undefined"!==typeof a.originalEvent.targetTouches?a.originalEvent.targetTouches[0]: null;b.xStart=c?c.pageX:a.clientX;b.yStart=c?c.pageY:a.clientY;b.$canister.on("touchmove.roller",b,z).one("touchend.roller touchcancel.roller",b,A)}function z(a){a.stopPropagation();var b=a.data,c="undefined"!==typeof a.originalEvent.targetTouches?a.originalEvent.targetTouches[0]:null;b.deltaX=b.xStart-(c?c.pageX:a.clientX);b.deltaY=b.yStart-(c?c.pageY:a.clientY);(-10>b.deltaX||10<b.deltaX)&&a.preventDefault();b.touchLeft=b.leftPosition-b.deltaX;0<b.touchLeft&&(b.touchLeft=0);b.touchLeft<b.maxMove&& (b.touchLeft=b.maxMove);b.useMargin?b.$canister.css({marginLeft:b.touchLeft}):b.$canister.css(m(b.touchLeft))}function A(a){a=a.data;a.touchEnd=(new Date).getTime();a.leftPosition=a.touchLeft;a.$canister.css(p(""));a.$canister.off("touchmove.roller touchend.roller touchcancel.roller");var b=q(a);a.touchPaged&&!a.swipe?g(a,b):(a.index=b,r(a));a.deltaX=null;a.touchStart=0;a.touchEnd=0}function B(a){a.preventDefault();a.stopPropagation();var b=a.data;h(b.autoTimer);a=b.index+(d(a.currentTarget).hasClass("next")? 1:-1);g(b,a)}function C(a){a.preventDefault();a.stopPropagation();var b=a.data;a=b.$paginationItems.index(d(a.currentTarget));h(b.autoTimer);g(b,a)}function g(a,b){0>b&&(b=0);b>a.pageCount&&(b=a.pageCount);if(a.single)a.$items.removeClass("active").eq(b).addClass("active");else{if(a.paged){var c=a.$items.eq(b).position();c&&(a.leftPosition=-c.left)}else a.leftPosition=-(b*a.pageMove);a.leftPosition<a.maxMove&&(a.leftPosition=a.maxMove);a.useMargin?a.$canister.css({marginLeft:a.leftPosition}):a.$canister.css(m(a.leftPosition))}a.index= b;a.callback.call(a.$roller,a.index);r(a)}function r(a){a.$captionItems.filter(".active").removeClass("active");a.$captionItems.eq(a.index).addClass("active");a.$paginationItems.filter(".active").removeClass("active");a.$paginationItems.eq(a.index).addClass("active");a.$items.removeClass("visible");if("Infinity"!=a.perPage)for(var b=0;b<a.perPage;b++)a.leftPosition==a.maxMove?a.$items.eq(a.count-1-b).addClass("visible"):a.$items.eq(a.perPage*a.index+b).addClass("visible");0>=a.pageCount?a.$controlItems.removeClass("enabled"): (a.$controlItems.addClass("enabled"),0>=a.index?a.$controlItems.filter(".previous").removeClass("enabled"):(a.index>=a.pageCount||a.leftPosition==a.maxMove)&&a.$controlItems.filter(".next").removeClass("enabled"))}function n(a){a=a.data;a.$roller.addClass("roller-initialized");a.count=a.$items.length;a.viewportWidth=0<a.$viewport.length?a.$viewport.outerWidth(!1):a.$roller.outerWidth(!1);if(a.paged){for(var b=a.maxWidth=0;b<a.count;b++)a.maxWidth+=a.$items.eq(b).outerWidth(!1);a.perPage=1;a.pageCount= a.maxWidth>a.viewportWidth?a.count-1:0}else a.itemMargin=parseInt(a.$items.eq(0).css("margin-left"),10)+parseInt(a.$items.eq(0).css("margin-right"),10),a.itemWidth=a.$items.eq(0).outerWidth(!1)+a.itemMargin,a.perPage=Math.floor(a.viewportWidth/a.itemWidth),1>a.perPage&&(a.perPage=1),a.pageCount=Math.ceil(a.count/a.perPage)-1,a.pageMove=a.itemWidth*a.perPage,a.maxWidth=a.itemWidth*a.count;a.maxMove=-a.maxWidth+a.viewportWidth;0<a.maxMove&&(a.maxMove=0);if("Infinity"!=a.pageCount){for(var c="",b=0;b<= a.pageCount;b++)c+='<span class="roller-page">'+b+"</span>";a.$pagination.html(c)}1>a.pageCount?(a.$controls.removeClass("visible"),a.$pagination.removeClass("visible")):(a.$controls.addClass("visible"),a.$pagination.addClass("visible"));a.$paginationItems=a.$roller.find(".roller-page");a.$canister.css({width:a.maxWidth});g(a,q(a));a.$roller.trigger("ready.roller");return a.$roller}function D(a){a=a.data;a.$items=a.$roller.find(".roller-item");n({data:a})}function v(a,b){var c=a.data;c&&(b>c.minWidth? (k.enable.apply(c.$roller),n({data:c})):k.disable.apply(c.$roller))}function q(a){if(a.single)return a.index;if((20<a.deltaX||-20>a.deltaX)&&a.touchStart&&a.touchEnd&&200>a.touchEnd-a.touchStart)return a.index+(0<a.deltaX?1:-1);if(a.paged){var b=Infinity;if(a.leftPosition==a.maxMove)return a.$items.length-1;var c=0;a.$items.each(function(f){var e=d(this).position().left+a.leftPosition;0>e&&(e=-e);e<b&&(b=e,c=f)});return c}return Math.round(-a.leftPosition/a.viewportWidth)}function m(a){return{"-webkit-transform":"translate3d("+ a+"px, 0, 0)","-moz-transform":"translate3d("+a+"px, 0, 0)","-ms-transform":"translate3d("+a+"px, 0, 0)","-o-transform":"translate3d("+a+"px, 0, 0)",transform:"translate3d("+a+"px, 0, 0)"}}function p(a){return{"-webkit-transition":a,"-moz-transition":a,"-ms-transition":a,"-o-transition":a,transition:a}}function w(a,b,c,d){h(a,d);return!0===d?setInterval(c,b):setTimeout(c,b)}function h(a){null!=a&&clearInterval(a)}var u=0,l={auto:!1,autoTime:8E3,callback:d.noop,customClass:"",duration:510,debounce:10, initOnload:!0,minWidth:0,paged:!1,single:!1,touchPaged:!0,useMargin:!1},k={defaults:function(a){l=d.extend(l,a||{});return d(this)},destroy:function(){return d(this)},disable:function(){return d(this).each(function(){var a=d(this).data("roller");a.enabled&&(h(a.autoTimer),a.$roller.removeClass("roller roller-initialized").off("touchstart.roller click.roller resize.roller reset.roller"),a.$canister.css({width:""}).off("touchstart.roller"),a.$pagination.html(""),a.useMargin?a.$canister.css({marginLeft:""}): a.$canister.css(m(0)),a.index=0);a.enabled=!1})},enable:function(){return d(this).each(function(){var a=d(this).data("roller");a.enabled||(a.$roller.data("roller",a).addClass("roller").on("touchstart.roller click.roller",".roller-control",a,B).on("touchstart.roller click.roller",".roller-page",a,C).on("resize.roller",a,n).on("reset.roller",a,D).trigger("resize.roller"),a.$canister.on("touchstart.roller",a,y));a.enabled=!0})},jump:function(a){return d(this).each(function(){var b=d(this).data("roller"); h(b.autoTimer);g(b,a-1)})}};d.fn.roller=function(a){return k[a]?k[a].apply(this,Array.prototype.slice.call(arguments,1)):"object"!==typeof a&&a?this:s.apply(this,arguments)}})(jQuery);