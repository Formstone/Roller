/*
 * Roller Plugin [Formtone Library]
 * @author Ben Plum
 * @version 1.0.0
 *
 * Copyright Â© 2013 Ben Plum <mr@benplum.com>
 * Released under the MIT License <http://www.opensource.org/licenses/mit-license.php>
 */

if(jQuery)(function(e){function p(a){a=e.extend({},l,a);for(var b=e(this),c=0,d=b.length;c<d;c++)q(b.eq(c),a);return b}function q(a,b){if(!a.data("roller")){var c=e.extend({},{$roller:a,$viewport:a.find(".roller-viewport"),$canister:a.find(".roller-canister"),$items:a.find(".roller-item"),$captions:a.find(".roller-captions"),$captionItems:a.find(".roller-caption"),$controls:a.find(".roller-controls"),$controlItems:a.find(".roller-control"),$pagination:a.find(".roller-pagination"),$paginationItems:a.find(".roller-page"), $images:a.find("img"),isAnimating:!1,index:-1,deltaX:null,deltaY:null,leftPosition:0,xStart:0,yStart:0,guid:r++,breakWidth:parseInt(a.data("max-width"))||Infinity,enabled:!1},b);c.totalImages=c.$images.length;f.enable(c);c.auto&&(c.autoTimer=m(c.autoTimer,c.autoTime,function(){var a=c.index+1;a>c.pageCount&&(a=0);g(c,a,!0);h(c.autoTimer)}));if(0<c.totalImages)for(var d=c.loadedImages=0;d<c.totalImages;d++){var k=c.$images.eq(d);k.one("load",c,s);(k[0].complete||k[0].height)&&k.trigger("load")}}}function s(a){a= a.data;a.loadedImages++;a.loadedImages==a.totalImages&&a.$roller.trigger("resize.roller");a.$roller.data("roller",a)}function t(a){var b=a.data;if(!e(a.target).hasClass("roller-control")&&!e(a.target).hasClass("roller-page")&&(h(b.autoTimer),b.startTime=(new Date).getTime(),b.startEvent=a,!b.isAnimating)){var c="undefined"!==typeof a.originalEvent.targetTouches?a.originalEvent.targetTouches[0]:null;b.xStart=c?c.pageX:a.clientX;b.yStart=c?c.pageY:a.clientY;Site.$window.on("touchmove.roller",b,u).one("touchend.roller", b,n).one("touchcancel.roller",b,n)}}function u(a){var b=a.data,c="undefined"!==typeof a.originalEvent.targetTouches?a.originalEvent.targetTouches[0]:null;b.deltaX=b.xStart-(c?c.pageX:a.clientX);b.deltaY=b.yStart-(c?c.pageY:a.clientY);b.deltaXCheck=0>b.deltaX?-b.deltaX:b.deltaX;b.deltaYCheck=0>b.deltaY?-b.deltaY:b.deltaY;20>b.deltaYCheck&&b.startEvent&&(b.startEvent.preventDefault(),b.startEvent.stopPropagation(),b.startEvent=null);10<b.deltaXCheck&&(a.preventDefault(),a.stopPropagation());a=b.leftPosition- b.deltaX;0<a&&(a=0);a<b.maxMove&&(a=b.maxMove);b.useMargin?b.$canister.css({marginLeft:a}):b.$canister.css({transform:"translate3D("+a+"px,0,0)"})}function n(a){var b=a.data,c=0.25*b.viewportWidth,d=b.index;b.endTime=(new Date).getTime();200<b.endTime-b.startTime&&(20<b.deltaXCheck||20<b.deltaYCheck)&&(a.preventDefault(),a.stopPropagation());b.startEvent=null;Site.$window.off("touchmove.roller").off("touchend.roller").off("touchcancle.roller");if(b.deltaX){if(b.deltaX>c||b.deltaX<-c)d=b.index+(b.leftPosition- b.deltaX<=b.leftPosition?1:-1);g(b,d,!0);b.deltaX=null}}function v(a){a.preventDefault();a.stopPropagation();var b=e(a.delegateTarget).data("roller");h(b.autoTimer);b.isAnimating||(a=b.index+(e(a.currentTarget).hasClass("next")?1:-1),g(b,a,!0))}function w(a){a.preventDefault();a.stopPropagation();var b=e(a.delegateTarget).data("roller");a=b.$paginationItems.index(e(a.currentTarget));h(b.autoTimer);g(b,a,!0)}function g(a,b,c){c&&(a.isAnimating=!0,a.$roller.addClass("animated"));0>b&&(b=0);b>a.pageCount&& (b=a.pageCount);if(a.paged){var d=a.$items.eq(b).position();a.leftPosition=-d.left}else a.leftPosition=-(b*a.pageMove);a.leftPosition<a.maxMove&&(a.leftPosition=a.maxMove);a.useMargin?a.$canister.css({marginLeft:a.leftPosition}):a.$canister.css({transform:"translate3D("+a.leftPosition+"px,0,0)"});a.$captionItems.filter(".active").removeClass("active");a.$captionItems.eq(b).addClass("active");a.$paginationItems.filter(".active").removeClass("active");a.$paginationItems.eq(b).addClass("active");a.$items.removeClass("visible"); if("Infinity"!=a.perPage)for(d=0;d<a.perPage;d++)a.leftPosition==a.maxMove?a.$items.eq(a.count-1-d).addClass("visible"):a.$items.eq(a.perPage*b+d).addClass("visible");a.index=b;a.$roller.data("roller",a);x(a);c&&m(a.autoTimer,a.duration,function(){a.isAnimating=!1;a.$roller.removeClass("animated")})}function x(a){0>=a.pageCount?a.$controlItems.addClass("disabled"):(a.$controlItems.removeClass("disabled"),0>=a.index?a.$controlItems.filter(".previous").addClass("disabled"):(a.index>=a.pageCount||a.leftPosition== a.maxMove)&&a.$controlItems.filter(".next").addClass("disabled"))}function m(a,b,c){h(a);return setTimeout(c,b)}function h(a){null!=a&&clearTimeout(a)}var r=0,l={autoTime:8E3,auto:!1,customClass:"",duration:500,paged:!1,useMargin:!1},f={defaults:function(a){l=e.extend(l,a||{});return e(this)},disable:function(a){a.enabled&&(h(a.autoTimer),a.$roller.removeClass("roller roller-initialized").off("click.roller").off("click.roller").off("resize.roller").off("reset.roller").off("touchstart.roller"),a.$pagination.html(""), a.useMargin?a.$canister.css({marginLeft:"0"}):a.$canister.css({transform:"translate3D(0,0,0)"}),a.index=0);a.enabled=!1},enable:function(a){a.enabled||a.$roller.data("roller",a).addClass("roller").on("click.roller",".roller-control",v).on("click.roller",".roller-page",w).on("resize.roller",a,f.resize).on("reset.roller",a,f.reset).on("respond.roller",a,f.respond).on("touchstart.roller",a,t).trigger("resize.roller");a.enabled=!0},jump:function(a,b,c){g(a,b,c||!0)},resize:function(a){var b=e(a.delegateTarget).data("roller"); b.autoTimer=m(b.autoTimer,Site.debounceTime,function(){b.$roller.addClass("roller-initialized");b.count=b.$items.length;b.viewportWidth=0<b.$viewport.length?b.$viewport.outerWidth(!0):b.$roller.outerWidth(!0);if(b.paged){for(var a=b.maxWidth=0;a<b.count;a++)b.maxWidth+=b.$items.eq(a).outerWidth(!1);b.perPage=1;b.pageCount=b.maxWidth>b.viewportWidth?b.count-1:0}else b.itemMargin=parseInt(b.$items.eq(0).css("margin-left"),10)+parseInt(b.$items.eq(0).css("margin-right"),10),b.itemWidth=b.$items.eq(0).outerWidth(!1)+ b.itemMargin,b.perPage=Math.floor(b.viewportWidth/b.itemWidth),1>b.perPage&&(b.perPage=1),b.pageCount=Math.ceil(b.count/b.perPage)-1,b.pageMove=b.itemWidth*b.perPage,b.maxWidth=b.itemWidth*b.count;b.maxMove=-b.maxWidth+b.viewportWidth;0<b.maxMove&&(b.maxMove=0);if("Infinity"!=b.pageCount){for(var d="",a=0;a<=b.pageCount;a++)d+='<span class="roller-page">'+a+"</span>";b.$pagination.html(d)}1>b.pageCount?(b.$controls.removeClass("visible"),b.$pagination.removeClass("visible")):(b.$controls.addClass("visible"), b.$pagination.addClass("visible"));b.$paginationItems=b.$roller.find(".roller-page");a=-Math.ceil(b.leftPosition/b.viewportWidth);g(b,a,!1)})},reset:function(a){a=e(a.delegateTarget).data("roller");a.$itemsAll=a.$roller.find(".roller_item");a.$items=a.$allItems.filter(":visible");a.$roller.trigger("resize.roller");g(a,a.index,!1)},respond:function(a){a=e(a.delegateTarget).data("roller");a.breakWidth>=Site.minWidth?f.enable(a):f.disable(a)}};e.fn.roller=function(a){return f[a]?f[a].apply(this,Array.prototype.slice.call(arguments, 1)):"object"!==typeof a&&a?this:p.apply(this,arguments)}})(jQuery);